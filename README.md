Docdoc: Модуль интеграции с МИС "MedWork"
===========================================

Данное программное обеспечение:

- разработано для любых 
версий ОС Windows, начиная с Windows 2000/XP и до Windows 10, и 
предназначено для обеспечения интеграции на онлайн-расписание Клиники, 
работающей на МИС "MedWork", и Docdoc.ru.

- представляет из себя набор скриптов с открытым исходным кодом;

---


Быстрая установка
---------

- Скачать архив с исходным кодом из нашего [репозитория](https://bitbucket.org/dfsru/docdoc_export_medwork/get/master.zip) и распаковать его в желаемое
место установки. Подробное описание [тут](#markdown-header-_1);
- настроить подключение скрипта к MS SQL базе и FTP DocDoc в файле config.bat, инструкция по настройке [здесь](#markdown-header-_2);

- [Проверить запуск компонентов](#markdown-header-_3) (docdoc_export.bat и docdoc_upload.bat) скрипта вручную. Первый 
должен сформировать данные для выгрузки в подкаталоге export, второй должен выгрузить данные на ftp;

- [Настроить автоматический запуск](#markdown-header-_4) docdoc_do_export.bat в планировщике задач Windows на запуск
каждые 15 минут.

Установка - детальное руководство
---------

#### Скачать архив с исходным кодом

Чтобы скачать репозиторий проекта перейдите по ссылке https://bitbucket.org/dfsru/docdoc_export_medwork и выбирете пункт "Downloads" в левом навигационном меню.

На открытой странице перейдите на вкладку "Branches" и нажмите ссылку на один из вариантов архива в колонке "Download", в строчке с веткой master. 
После скачивания архива, распакуйте его в желаемое место установки, например "C:\docdoc_export".

После распаковки архива вы увидите следующие файлы:

      export/                   папка для временного хранения файлов выгрузки
      sql/                      SQL скрипты для чтения данных из базы данных MedWork
      winscp/                   сторонний ftp клиент, внутри только бинарные файлы и конфиг
      tmp/                      временные файлы
      docdoc_do_export.bat      основной скрипт
      docdoc_export.bat         скрипт генерации файлов выгрузки
      docdoc_export_config.bat  конфигурационный файл
      docdoc_upload.bat         скрипт загрузки подготовленных файлов на FTP
      readme.md                 этот файл с инструкцией

---

#### Настройка скрипта

Все исполняемые shell-скрипты .bat находятся в корне папки.

Для настройки потребуется выполнить следующие шаги:

- Настроить пользователя БД MedWork "dbuser" и его пароль "dbpass". Для выгрузки можно использовать любого, у которого есть права 
на чтение соответствующих таблиц БД Медиалог. Название таблиц можно посмотреть в исходных файлах
с sql запросами каталог "sql";

- Имя сервера на котором расположена база данных "dbservername", например "MEDWORK-VR\SQLEXPRESS";

- Указать название базы данных MedWork в "dbname"

- Далее, необходимо прописать в "sql_cmd_path" полный путь до каталога, в котором
находится консольный mssql клиент. Как правило по умолчанию это "C:\Program Files\Microsoft SQL Server\100\Tools\Binn\";

- После нужно настроить подключение к нашему FTP серверу (доступ предоставляем мы). 
Для этого нужно указать в "ftpuser" пользователя, в "ftppass" пароль для доступа,
в "ftpstartdir" относительный путь каталога в который будут сохраняться файлы.
Остальные настройки "winscppath" путь до ftp клиента и "ftplogpath" лог файл ftp сессий,
оставляем без изменений.

#### Проверить запуск компонентов

- Запускаем docdoc_export.bat . Этот скрипт отвечает за выгрузку данных для
онлайн-расписания из таблиц БД Медиалог в формат CSV в подпапку /export.

Подпапка /export должна быть доступна для записи учетной записи windows, 
из под которой запускается скрипт.

CSV формат файлов выбран стандартный для русскоязычной версии MS Excel:

- разделителем столбцов является точка-с-запятой ";",
- значения данных обрамлены в двойные кавычки
- в случае встречи символа <"> он экранируется как <"">
- конец строки в windows стиле (символы CR+LF)

Это позволяет, в частности, совершенно просто открывать эти файлы в 
MS Excel для просмотра.

Пример вывода в консоль при корректной отработке скрипта:

    Loading...
    Cleaning from old export files
    Generate new fresh export files
    - organizations
    - departments
    - doctors schedule_patterns
    - schedule_corrections    
    - busy_slots    
    - prerecords    
    - blocked_time events    
    Prepare export files for uploading
    - organizations
    - departments
    - doctors schedule_patterns
    - schedule_corrections    
    - busy_slots    
    - prerecords    
    - blocked_time events
    Export files generated.

      
В результате успешной отработки скрипта, в папке /export должны будут
создаться (или перезаписаться) соответственно файлы

    - organizations.csv
    - departments.csv
    - doctors schedule_patterns.csv
    - schedule_corrections.csv
    - busy_slots.csv
    - prerecords.csv
    - blocked_time events.csv

которые можно просмотреть на корректность отдаваемых данных как в любом
текстовом редакторе, так и в табличном виде, открыв через Excel.

- Запускаем docdoc_upload.bat. 

Этот скрипт отвечает за отправку подготовленных предыдущим 
(docdoc_export.bat) скриптом файлов данных для онлайн-расписания
из папки /export в сеть на FTP сервер Docdoc.

Подпапка /tmp должна быть доступна для записи учетной записи Windows, 
из под которой запускается скрипт.

Это требуется ввиду того, что в начале работы скрипта в /tmp генерируется
временный файл, в который записывается последовательность FTP команд для winscp.
Winscp это opensource ftp-клиент, мы в нашем скрипте поставляем только исполняемые файлы.
Устанавливать его в системе не требуется. Если в вашей системе имеется фаерволл, нужно
добавить для него разрешающие правила.

Лог ftp сессии сохраняется в файле указанном в переменной "ftplogpath",
по-умолчанию это "ftp.log".

#### Настроить автоматический запуск

Скрипт docdoc_do_export.bat для обеспечения автоматической выгрузки делает
ничто иное как последовательно запускает

- docdoc_export.bat для генерации свежих файлов для экспорта
- и затем сразу docdoc_upload.bat для закачки этих файлов на FTP

и более ничего.

Убедившись в корректной работе каждого из компонентов в режиме ручного
запуска, нужно прописать docdoc_do_export.bat в планировщике задач 
Windows на запуск каждые 15 минут.

При настройке задания в планировщике не забудьте указать рабочий каталог
как место в которое вы установиле данный скрипт. Это нужно для корректной
работы скрипта при автоматическом запуске.

Так же следует соблюдать рекомендации по безопасности:

Для скрипта с конфигурационными настройками docdoc_export_config.bat,
а также до содержимого подпапки /tmp, рекомендуется  ограничить доступ
только для администраторов (и юзера, из под которого запускается скрипт,
в случае запуска скрипта не под администратором). Для всех остальных не
следует предоставлять доступ даже на чтение, ввиду хранения в этих файлах
конфиденциальных данных вроде логинов и паролей.

СИСТЕМНЫЕ ТРЕБОВАНИЯ
--------------------

### Операционная система:

Клиентские системы Windows 2000, Windows XP SP2 и SP3 и выше

Серверные системы Windows Server 2003, 2008 и выше


### Требования к железу:

Минимальны, решение работоспособно на уровне компьютерной
техники 2000-х годов и выше.

Для примера, будет работать вполне неплохо на конфигурации с
Intel Pentium IV @2.6 ГГц (одноядерный, с HT)
и 16 Мб свободной оперативной памяти.

Естественно, желательна более современная конфигурация.


### Доступ в сеть интернет:

Скорость от 1 Мбит/с входящая, от 1 Мбит/с исходящая

---

На технике и связи с сетью уровня 2016-го года работа скриптов практически моментальна.

---


### Контакты

По вопросам по модулю и поддержке обращайтесь к нам на support@docdoc.ru

Команда разработчиков Докдок
http://docdoc.ru